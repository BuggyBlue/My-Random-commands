#!/usr/bin/env python3
"""
RECONNAISSANCE ASSISTANT SCRIPT

USAGE RESTRICTIONS:
- FOR USE ONLY on systems and domains where you have explicit, written authorization.
- Unauthorized use is illegal and unethical.

Supported functions:
- WHOIS lookup
- DNS lookup (nslookup)
- Nmap scan on ports 80/443

Results are saved in 'results/' folder.
"""

import os
import sys
import argparse
import subprocess
import re

RESULTS_DIR = "results"

def check_tool_installed(tool):
    """Check if a system tool is installed."""
    from shutil import which
    return which(tool) is not None

def run_command(command, outfile):
    """Run a system command and save its output."""
    try:
        result = subprocess.run(command, capture_output=True, text=True, timeout=30)
    except Exception as e:
        return f"ERROR: {e}"
    with open(outfile, "w", encoding="utf-8") as f:
        f.write(result.stdout + result.stderr)
    return result.stdout + result.stderr

def is_valid_domain(domain):
    """Basic domain name validation."""
    pattern = (r"^(?!-)[A-Z\d-]{1,63}(?<!-)"
               r"(\.(?!-)[A-Z\d-]{1,63}(?<!-))*"
               r"\.[A-Z]{2,6}\.?$", re.IGNORECASE)
    return re.match(pattern[0], domain, pattern[1])

def ai_summary(whois_text, nslookup_text, nmap_text):
    """
    Mocked "AI" summary function. Replace this logic with LLM call later.
    """
    # TODO: Integrate with an LLM (e.g. OpenAI API) for deeper summary.
    summary = []
    summary.append("=== SUMMARY REPORT (for authorized use only) ===")
    # Whois: registrar/org info
    registrar = next((line for line in whois_text.splitlines() if "Registrar:" in line or "OrgName:" in line), "Registrar: Not found")
    summary.append(f"Whois: {registrar.strip()}")
    # DNS: main records
    dns_lines = [line for line in nslookup_text.splitlines() if "Name:" in line or "Address:" in line]
    summary.append(f"DNS records sample: {', '.join(dns_lines[:3]) if dns_lines else 'Not found'}")
    # Nmap: find open services
    open_ports = [line for line in nmap_text.splitlines() if "open" in line]
    summary.append(f"Open ports found: {', '.join(open_ports) if open_ports else 'None detected'}")
    # Suggest next steps
    summary.append("Suggested next steps: Review open services, enumerate directories, check for outdated software signatures, investigate subdomains (with permission).")
    return "\n".join(summary)

def main():
    parser = argparse.ArgumentParser(
        description="Reconnaissance Assistant: For use ONLY on domains/systems you are authorized to test.",
        add_help=False,
    )
    parser.add_argument('--help', action='help', help='Show this help message and exit')
    parser.add_argument('domain', nargs='?', help='Target domain for reconnaissance')
    args = parser.parse_args()

    # Tool requirement check
    required_tools = ['whois', 'nslookup', 'nmap']
    missing = [tool for tool in required_tools if not check_tool_installed(tool)]
    if missing:
        print(f"ERROR: Missing required tools: {', '.join(missing)}", file=sys.stderr)
        sys.exit(1)

    # Get domain
    domain = args.domain
    if not domain:
        domain = input("Enter the domain (e.g., example.com): ").strip()
    if not is_valid_domain(domain):
        print("ERROR: Invalid domain name format.", file=sys.stderr)
        sys.exit(2)

    # Ensure results directory exists
    os.makedirs(RESULTS_DIR, exist_ok=True)

    # Recon Steps
    outputs = {}

    print(f"[*] Running WHOIS for {domain} ...")
    outputs['whois'] = run_command(['whois', domain], os.path.join(RESULTS_DIR, "whois.txt"))

    print(f"[*] Running nslookup for {domain} ...")
    outputs['nslookup'] = run_command(['nslookup', domain], os.path.join(RESULTS_DIR, "nslookup.txt"))

    print(f"[*] Running nmap scan on {domain} ports 80,443 ...")
    outputs['nmap'] = run_command(['nmap', '-Pn', '-p', '80,443', domain], os.path.join(RESULTS_DIR, "nmap.txt"))

    # Read data back (you'd do this anyway for AI/summary step)
    with open(os.path.join(RESULTS_DIR, "whois.txt"), encoding="utf-8") as f:
        whois_text = f.read()
    with open(os.path.join(RESULTS_DIR, "nslookup.txt"), encoding="utf-8") as f:
        nslookup_text = f.read()
    with open(os.path.join(RESULTS_DIR, "nmap.txt"), encoding="utf-8") as f:
        nmap_text = f.read()

    print("\n" + "="*32)
    print(ai_summary(whois_text, nslookup_text, nmap_text))
    print("="*32 + "\n")
    print(f"Raw results saved under ./{RESULTS_DIR}/")

if __name__ == "__main__":
    main()
